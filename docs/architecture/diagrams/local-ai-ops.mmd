flowchart TB
    subgraph Internet["Internet (Optional)"]
        ModelRepo[Model Updates<br/>Ollama Registry]
    end

    subgraph Home_Network["Your Private Network<br/><b>EVERYTHING STAYS LOCAL</b>"]

        subgraph Local_AI["Local AI Layer (Air-Gap Compatible)"]
            direction TB
            Ollama[Ollama Server<br/>localhost:11434]

            subgraph Models["AI Models (Local Storage)"]
                LLaMA[LLaMA3.1 70B<br/>General ops]
                Mistral[Mistral 8x22B<br/>Complex reasoning]
                Qwen[Qwen2.5 72B<br/>Documentation]
            end

            Ollama --> Models
        end

        subgraph Agent_Layer["Specialized Agents (10 total)"]
            direction LR
            HAValidator[ha-yaml-validator<br/>Prevents automation bugs]
            DockerTrouble[docker-troubleshooter<br/>Container diagnostics]
            BackupVal[backup-validator<br/>DR automation]
            SecurityAud[security-auditor<br/>Compliance scanning]
            Other[+ 6 more agents...]
        end

        subgraph CSE["CSE Guardrails<br/><b>Human-Gated Privileges</b>"]
            direction TB
            Policy[CSE Policy Engine<br/>Time-boxed access]
            Audit[Audit Log<br/>Every action recorded]
            Runbooks[Runbook References<br/>Required for approval]

            Policy --> Audit
            Policy --> Runbooks
        end

        subgraph MCP_Tools["MCP Tools (65 total - Local stdio transport)"]
            direction LR

            subgraph Infrastructure["Infrastructure (7 Systems)"]
                Docker[Docker Manager<br/>8 tools]
                HA[Home Assistant<br/>12 tools]
                Frigate[Frigate NVR<br/>7 tools]
                Proxmox[Proxmox<br/>8 tools]
                pfSense[pfSense<br/>10 tools]
                n8n[n8n<br/>8 tools]
                DB[Database<br/>12 tools]
            end
        end

        subgraph Services["Your Infrastructure"]
            direction LR
            Containers[Docker Containers]
            VMs[Proxmox VMs/LXCs]
            Network[pfSense Firewall]
            Automation[Home Assistant]
            Monitoring[Frigate + n8n]
        end

        %% Connections
        Local_AI --> Agent_Layer
        Agent_Layer --> CSE
        CSE --> MCP_Tools
        MCP_Tools --> Services

        %% Optional internet for model updates only
        Internet -.->|Model Updates<br/>ONLY| Ollama
    end

    %% Styling
    classDef privateZone fill:#e1f5e1,stroke:#2d5016,stroke-width:3px
    classDef aiLayer fill:#fff3cd,stroke:#856404,stroke-width:2px
    classDef secureLayer fill:#f8d7da,stroke:#721c24,stroke-width:2px
    classDef toolLayer fill:#d1ecf1,stroke:#0c5460,stroke-width:2px
    classDef internetOptional fill:#f0f0f0,stroke:#999,stroke-width:2px,stroke-dasharray: 5 5

    class Home_Network privateZone
    class Local_AI,Agent_Layer aiLayer
    class CSE secureLayer
    class MCP_Tools,Infrastructure toolLayer
    class Internet,ModelRepo internetOptional
